#!/bin/bash

VERSION="1.3"
PREVIEW=false
QUIET=false
VERBOSE=false
COLOR=true
CONFIG_FILE="$HOME/.mvprc"
CONFIRM_LARGE_MOVES=false
LARGE_FILE_THRESHOLD=1073741824
EXCLUDE_PATTERNS=""

load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        while IFS='=' read -r key value; do
            [[ "$key" =~ ^#.*$ ]] && continue
            [[ -z "$key" ]] && continue
            
            key=$(echo "$key" | xargs)
            value=$(echo "$value" | xargs)
            
            case "$key" in
                COLOR)
                    [[ "$value" =~ ^(true|false)$ ]] && COLOR="$value"
                    ;;
                VERBOSE)
                    [[ "$value" =~ ^(true|false)$ ]] && VERBOSE="$value"
                    ;;
                QUIET)
                    [[ "$value" =~ ^(true|false)$ ]] && QUIET="$value"
                    ;;
                RSYNC_BANDWIDTH_LIMIT)
                    [[ "$value" =~ ^[0-9]+$ ]] && RSYNC_BW_LIMIT="$value"
                    ;;
                RSYNC_EXTRA_OPTIONS)
                    RSYNC_EXTRA_OPTS="$value"
                    ;;
                CONFIRM_LARGE_MOVES)
                    [[ "$value" =~ ^(true|false)$ ]] && CONFIRM_LARGE_MOVES="$value"
                    ;;
                LARGE_FILE_THRESHOLD)
                    [[ "$value" =~ ^[0-9]+$ ]] && LARGE_FILE_THRESHOLD="$value"
                    ;;
                EXCLUDE_PATTERNS)
                    EXCLUDE_PATTERNS="$value"
                    ;;
            esac
        done < "$CONFIG_FILE"
    fi
}

load_config

if [[ -t 1 ]] && command -v tput &> /dev/null && [ "$COLOR" = true ]; then
    COLOR_RESET=$(tput sgr0)
    COLOR_BOLD=$(tput bold)
    COLOR_RED=$(tput setaf 1)
    COLOR_GREEN=$(tput setaf 2)
    COLOR_YELLOW=$(tput setaf 3)
    COLOR_BLUE=$(tput setaf 4)
    COLOR_CYAN=$(tput setaf 6)
else
    COLOR=false
    COLOR_RESET=""
    COLOR_BOLD=""
    COLOR_RED=""
    COLOR_GREEN=""
    COLOR_YELLOW=""
    COLOR_BLUE=""
    COLOR_CYAN=""
fi

show_help() {
    cat << EOF
mvp - Move with Progress v${VERSION}

Usage: mvp [options] source(s) destination

Options:
    -p, --preview     Preview operations without executing
    -q, --quiet       Suppress progress output
    -v, --verbose     Verbose output
    --no-color        Disable colored output
    -h, --help        Show this help message
    --config          Show current configuration

Configuration:
    Config file: ~/.mvprc
    
    Supported options:
      COLOR=true|false              Enable/disable colors
      VERBOSE=true|false            Enable/disable verbose mode
      QUIET=true|false              Enable/disable quiet mode
      RSYNC_BANDWIDTH_LIMIT=N       Limit bandwidth (KB/s)
      RSYNC_EXTRA_OPTIONS="..."     Extra rsync options
      CONFIRM_LARGE_MOVES=true|false    Confirm before moving large files
      LARGE_FILE_THRESHOLD=N        Size threshold in bytes (default: 1GB)
      EXCLUDE_PATTERNS="..."        Comma-separated patterns to exclude

Examples:
    mvp file.txt /destination/
    mvp source/* /destination/
    mvp -p *.log /backup/
    mvp -q large_file.iso /media/

EOF
}

show_config() {
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo "${COLOR_BOLD}Current Configuration${COLOR_RESET}"
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo ""
    echo "${COLOR_BLUE}Config file:${COLOR_RESET} $CONFIG_FILE"
    if [ -f "$CONFIG_FILE" ]; then
        echo "${COLOR_GREEN}Status: Found${COLOR_RESET}"
    else
        echo "${COLOR_YELLOW}Status: Not found (using defaults)${COLOR_RESET}"
    fi
    echo ""
    echo "${COLOR_BOLD}Active settings:${COLOR_RESET}"
    echo "  COLOR:                  $COLOR"
    echo "  VERBOSE:                $VERBOSE"
    echo "  QUIET:                  $QUIET"
    echo "  RSYNC_BANDWIDTH_LIMIT:  ${RSYNC_BW_LIMIT:-not set}"
    echo "  RSYNC_EXTRA_OPTIONS:    ${RSYNC_EXTRA_OPTS:-not set}"
    echo "  CONFIRM_LARGE_MOVES:    $CONFIRM_LARGE_MOVES"
    
    local threshold_display="$LARGE_FILE_THRESHOLD bytes"
    if [ $LARGE_FILE_THRESHOLD -ge 1073741824 ]; then
        threshold_display="$((LARGE_FILE_THRESHOLD / 1073741824)) GB"
    elif [ $LARGE_FILE_THRESHOLD -ge 1048576 ]; then
        threshold_display="$((LARGE_FILE_THRESHOLD / 1048576)) MB"
    elif [ $LARGE_FILE_THRESHOLD -ge 1024 ]; then
        threshold_display="$((LARGE_FILE_THRESHOLD / 1024)) KB"
    fi
    
    echo "  LARGE_FILE_THRESHOLD:   $threshold_display"
    echo "  EXCLUDE_PATTERNS:       ${EXCLUDE_PATTERNS:-not set}"
    echo ""
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
}

ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--preview)
            PREVIEW=true
            shift
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        --no-color)
            COLOR=false
            COLOR_RESET=""
            COLOR_BOLD=""
            COLOR_RED=""
            COLOR_GREEN=""
            COLOR_YELLOW=""
            COLOR_BLUE=""
            COLOR_CYAN=""
            shift
            ;;
        --config)
            show_config
            exit 0
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

if [ ${#ARGS[@]} -lt 2 ]; then
    echo "${COLOR_RED}Error: Missing arguments${COLOR_RESET}"
    show_help
    exit 1
fi

DEST="${ARGS[-1]}"
unset 'ARGS[-1]'
SOURCES=("${ARGS[@]}")

if [ ${#SOURCES[@]} -gt 1 ] || [ -d "$DEST" ]; then
    if [ ! -d "$DEST" ]; then
        echo "${COLOR_RED}Error: Destination must be a directory when moving multiple files${COLOR_RESET}"
        exit 1
    fi
fi

same_filesystem() {
    local src="$1"
    local dst="$2"
    
    src_fs=$(df "$src" 2>/dev/null | tail -1 | awk '{print $1}')
    dst_fs=$(df "$dst" 2>/dev/null | tail -1 | awk '{print $1}')
    
    [ "$src_fs" = "$dst_fs" ]
}

get_size() {
    du -sb "$1" 2>/dev/null | awk '{print $1}'
}

format_size() {
    local size=$1
    if [ -z "$size" ] || [ "$size" -eq 0 ]; then
        echo "0B"
    elif [ $size -lt 1024 ]; then
        echo "${size}B"
    elif [ $size -lt 1048576 ]; then
        echo "$(( size / 1024 ))KB"
    elif [ $size -lt 1073741824 ]; then
        echo "$(( size / 1048576 ))MB"
    else
        echo "$(( size / 1073741824 ))GB"
    fi
}

calculate_total_size() {
    local total=0
    for src in "${SOURCES[@]}"; do
        if [ -e "$src" ]; then
            local size=$(get_size "$src")
            total=$((total + size))
        fi
    done
    echo $total
}

format_time() {
    local seconds=$1
    if [ -z "$seconds" ] || [ "$seconds" -eq 0 ]; then
        echo "0s"
    elif [ $seconds -lt 60 ]; then
        echo "${seconds}s"
    elif [ $seconds -lt 3600 ]; then
        local mins=$((seconds / 60))
        local secs=$((seconds % 60))
        echo "${mins}m ${secs}s"
    else
        local hours=$((seconds / 3600))
        local mins=$(((seconds % 3600) / 60))
        echo "${hours}h ${mins}m"
    fi
}

should_exclude() {
    local filename="$1"
    local basename=$(basename "$filename")
    
    if [ -z "$EXCLUDE_PATTERNS" ]; then
        return 1
    fi
    
    IFS=',' read -ra PATTERNS <<< "$EXCLUDE_PATTERNS"
    for pattern in "${PATTERNS[@]}"; do
        pattern=$(echo "$pattern" | xargs)
        if [[ "$basename" == $pattern ]]; then
            return 0
        fi
    done
    
    return 1
}

confirm_large_move() {
    local src="$1"
    local size="$2"
    
    if [ "$CONFIRM_LARGE_MOVES" = false ]; then
        return 0
    fi
    
    if [ "$size" -ge "$LARGE_FILE_THRESHOLD" ]; then
        local size_fmt=$(format_size $size)
        echo ""
        echo "${COLOR_YELLOW}Warning: Large file/directory detected${COLOR_RESET}"
        echo "  ${COLOR_BOLD}$src${COLOR_RESET} (${COLOR_BLUE}$size_fmt${COLOR_RESET})"
        echo ""
        read -p "Continue with move? (y/N): " -n 1 -r
        echo ""
        
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "${COLOR_YELLOW}Skipped${COLOR_RESET}"
            return 1
        fi
    fi
    
    return 0
}

START_TIME=0
TOTAL_SIZE=0
PROCESSED_SIZE=0

move_item() {
    local src="$1"
    local dst="$2"
    
    local final_dest="$dst"
    if [ -d "$dst" ]; then
        final_dest="$dst/$(basename "$src")"
    fi
    
    if [ ! -e "$src" ]; then
        [ "$QUIET" = false ] && echo "${COLOR_YELLOW}Warning: $src does not exist, skipping${COLOR_RESET}"
        return 1
    fi
    
    if should_exclude "$src"; then
        [ "$QUIET" = false ] && [ "$VERBOSE" = true ] && echo "${COLOR_YELLOW}Excluded:${COLOR_RESET} $src (matches pattern)"
        return 1
    fi
    
    local item_size=$(get_size "$src")
    
    if [ "$PREVIEW" = false ]; then
        if ! confirm_large_move "$src" "$item_size"; then
            return 1
        fi
    fi
    
    if [ "$PREVIEW" = true ]; then
        local size_fmt=$(format_size $item_size)
        echo "${COLOR_CYAN}[PREVIEW]${COLOR_RESET} Would move: ${COLOR_BOLD}$src${COLOR_RESET} -> ${COLOR_BOLD}$final_dest${COLOR_RESET} (${COLOR_BLUE}$size_fmt${COLOR_RESET})"
        return 0
    fi
    
    if [ "$QUIET" = false ]; then
        local size_fmt=$(format_size $item_size)
        echo "${COLOR_GREEN}Moving:${COLOR_RESET} ${COLOR_BOLD}$src${COLOR_RESET} -> ${COLOR_BOLD}$final_dest${COLOR_RESET} (${COLOR_BLUE}$size_fmt${COLOR_RESET})"
    fi
    
    if same_filesystem "$src" "$(dirname "$final_dest")"; then
        [ "$VERBOSE" = true ] && echo "  ${COLOR_CYAN}→${COLOR_RESET} Same filesystem, instant move"
        mv "$src" "$final_dest"
        PROCESSED_SIZE=$((PROCESSED_SIZE + item_size))
    else
        [ "$VERBOSE" = true ] && echo "  ${COLOR_CYAN}→${COLOR_RESET} Cross-filesystem, copying with progress..."
        
        RSYNC_OPTS="-ah --progress --remove-source-files"
        
        if [ -n "$RSYNC_BW_LIMIT" ]; then
            RSYNC_OPTS="$RSYNC_OPTS --bwlimit=$RSYNC_BW_LIMIT"
            [ "$VERBOSE" = true ] && echo "  ${COLOR_YELLOW}→${COLOR_RESET} Bandwidth limit: $(format_size $((RSYNC_BW_LIMIT * 1024)))/s"
        fi
        
        if [ -n "$RSYNC_EXTRA_OPTS" ]; then
            RSYNC_OPTS="$RSYNC_OPTS $RSYNC_EXTRA_OPTS"
        fi
        
        if [ "$QUIET" = true ]; then
            rsync -a --remove-source-files ${RSYNC_EXTRA_OPTS} "$src" "$final_dest" 2>/dev/null
        else
            if [ $TOTAL_SIZE -gt 0 ] && [ $PROCESSED_SIZE -gt 0 ]; then
                elapsed=$(($(date +%s) - START_TIME))
                speed=$((PROCESSED_SIZE / elapsed))
                if [ $speed -gt 0 ]; then
                    remaining=$((TOTAL_SIZE - PROCESSED_SIZE))
                    eta=$((remaining / speed))
                    eta_fmt=$(format_time $eta)
                    echo "  ${COLOR_YELLOW}ETA:${COLOR_RESET} $eta_fmt (${COLOR_BLUE}$(format_size $speed)/s${COLOR_RESET})"
                fi
            fi
            
            rsync $RSYNC_OPTS "$src" "$final_dest"
        fi
        
        PROCESSED_SIZE=$((PROCESSED_SIZE + item_size))
        
        if [ -d "$src" ]; then
            find "$src" -type d -empty -delete 2>/dev/null
        fi
    fi
    
    return $?
}

TOTAL_FILES=${#SOURCES[@]}
SUCCESS_COUNT=0
FAIL_COUNT=0

if [ "$PREVIEW" = false ]; then
    START_TIME=$(date +%s)
    TOTAL_SIZE=$(calculate_total_size)
    
    if [ "$QUIET" = false ]; then
        echo "${COLOR_BLUE}Total size to move:${COLOR_RESET} ${COLOR_BOLD}$(format_size $TOTAL_SIZE)${COLOR_RESET}"
        echo ""
    fi
fi

if [ "$PREVIEW" = true ]; then
    TOTAL_SIZE=$(calculate_total_size)
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo "${COLOR_BOLD}PREVIEW MODE - No files will be moved${COLOR_RESET}"
    echo "${COLOR_BLUE}Total size:${COLOR_RESET} ${COLOR_BOLD}$(format_size $TOTAL_SIZE)${COLOR_RESET}"
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo ""
fi

for source in "${SOURCES[@]}"; do
    if move_item "$source" "$DEST"; then
        ((SUCCESS_COUNT++))
    else
        ((FAIL_COUNT++))
    fi
done

if [ "$QUIET" = false ] && [ "$PREVIEW" = false ]; then
    end_time=$(date +%s)
    total_time=$((end_time - START_TIME))
    time_fmt=$(format_time $total_time)
    
    echo ""
    echo "${COLOR_GREEN}=========================================${COLOR_RESET}"
    echo "${COLOR_BOLD}${COLOR_GREEN}Move completed in $time_fmt!${COLOR_RESET}"
    
    if [ $total_time -gt 0 ]; then
        avg_speed=$((TOTAL_SIZE / total_time))
        echo "${COLOR_BLUE}Average speed:${COLOR_RESET} ${COLOR_BOLD}$(format_size $avg_speed)/s${COLOR_RESET}"
    fi
    
    echo "${COLOR_BLUE}Total:${COLOR_RESET} $TOTAL_FILES | ${COLOR_GREEN}Success:${COLOR_RESET} $SUCCESS_COUNT | ${COLOR_RED}Failed:${COLOR_RESET} $FAIL_COUNT"
    echo "${COLOR_GREEN}=========================================${COLOR_RESET}"
elif [ "$PREVIEW" = true ]; then
    echo ""
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo "${COLOR_BOLD}Preview completed - $TOTAL_FILES items would be moved${COLOR_RESET}"
    echo "${COLOR_BLUE}Estimated size:${COLOR_RESET} ${COLOR_BOLD}$(format_size $TOTAL_SIZE)${COLOR_RESET}"
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
fi

exit $([ $FAIL_COUNT -eq 0 ] && echo 0 || echo 1)
