#!/bin/bash

VERSION="1.1"
PREVIEW=false
QUIET=false
VERBOSE=false
COLOR=true

if [[ -t 1 ]] && command -v tput &> /dev/null; then
    COLOR_RESET=$(tput sgr0)
    COLOR_BOLD=$(tput bold)
    COLOR_RED=$(tput setaf 1)
    COLOR_GREEN=$(tput setaf 2)
    COLOR_YELLOW=$(tput setaf 3)
    COLOR_BLUE=$(tput setaf 4)
    COLOR_CYAN=$(tput setaf 6)
else
    COLOR=false
    COLOR_RESET=""
    COLOR_BOLD=""
    COLOR_RED=""
    COLOR_GREEN=""
    COLOR_YELLOW=""
    COLOR_BLUE=""
    COLOR_CYAN=""
fi

show_help() {
    cat << EOF
mvp - Move with Progress v${VERSION}

Usage: mvp [options] source(s) destination

Options:
    -p, --preview     Preview operations without executing
    -q, --quiet       Suppress progress output
    -v, --verbose     Verbose output
    --no-color        Disable colored output
    -h, --help        Show this help message

Examples:
    mvp file.txt /destination/
    mvp source/* /destination/
    mvp -p *.log /backup/
    mvp -q large_file.iso /media/

EOF
}

ARGS=()
while [[ $# -gt 0 ]]; do
    case $1 in
        -p|--preview)
            PREVIEW=true
            shift
            ;;
        -q|--quiet)
            QUIET=true
            shift
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        --no-color)
            COLOR=false
            COLOR_RESET=""
            COLOR_BOLD=""
            COLOR_RED=""
            COLOR_GREEN=""
            COLOR_YELLOW=""
            COLOR_BLUE=""
            COLOR_CYAN=""
            shift
            ;;
        -h|--help)
            show_help
            exit 0
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

if [ ${#ARGS[@]} -lt 2 ]; then
    echo "${COLOR_RED}Error: Missing arguments${COLOR_RESET}"
    show_help
    exit 1
fi

DEST="${ARGS[-1]}"
unset 'ARGS[-1]'
SOURCES=("${ARGS[@]}")

if [ ${#SOURCES[@]} -gt 1 ] || [ -d "$DEST" ]; then
    if [ ! -d "$DEST" ]; then
        echo "${COLOR_RED}Error: Destination must be a directory when moving multiple files${COLOR_RESET}"
        exit 1
    fi
fi

same_filesystem() {
    local src="$1"
    local dst="$2"
    
    src_fs=$(df "$src" 2>/dev/null | tail -1 | awk '{print $1}')
    dst_fs=$(df "$dst" 2>/dev/null | tail -1 | awk '{print $1}')
    
    [ "$src_fs" = "$dst_fs" ]
}

get_size() {
    du -sb "$1" 2>/dev/null | awk '{print $1}'
}

format_size() {
    local size=$1
    if [ -z "$size" ] || [ "$size" -eq 0 ]; then
        echo "0B"
    elif [ $size -lt 1024 ]; then
        echo "${size}B"
    elif [ $size -lt 1048576 ]; then
        echo "$(( size / 1024 ))KB"
    elif [ $size -lt 1073741824 ]; then
        echo "$(( size / 1048576 ))MB"
    else
        echo "$(( size / 1073741824 ))GB"
    fi
}

calculate_total_size() {
    local total=0
    for src in "${SOURCES[@]}"; do
        if [ -e "$src" ]; then
            local size=$(get_size "$src")
            total=$((total + size))
        fi
    done
    echo $total
}

format_time() {
    local seconds=$1
    if [ -z "$seconds" ] || [ "$seconds" -eq 0 ]; then
        echo "0s"
    elif [ $seconds -lt 60 ]; then
        echo "${seconds}s"
    elif [ $seconds -lt 3600 ]; then
        local mins=$((seconds / 60))
        local secs=$((seconds % 60))
        echo "${mins}m ${secs}s"
    else
        local hours=$((seconds / 3600))
        local mins=$(((seconds % 3600) / 60))
        echo "${hours}h ${mins}m"
    fi
}

START_TIME=0
TOTAL_SIZE=0
PROCESSED_SIZE=0

move_item() {
    local src="$1"
    local dst="$2"
    
    local final_dest="$dst"
    if [ -d "$dst" ]; then
        final_dest="$dst/$(basename "$src")"
    fi
    
    if [ ! -e "$src" ]; then
        [ "$QUIET" = false ] && echo "${COLOR_YELLOW}Warning: $src does not exist, skipping${COLOR_RESET}"
        return 1
    fi
    
    local item_size=$(get_size "$src")
    
    if [ "$PREVIEW" = true ]; then
        local size_fmt=$(format_size $item_size)
        echo "${COLOR_CYAN}[PREVIEW]${COLOR_RESET} Would move: ${COLOR_BOLD}$src${COLOR_RESET} -> ${COLOR_BOLD}$final_dest${COLOR_RESET} (${COLOR_BLUE}$size_fmt${COLOR_RESET})"
        return 0
    fi
    
    if [ "$QUIET" = false ]; then
        local size_fmt=$(format_size $item_size)
        echo "${COLOR_GREEN}Moving:${COLOR_RESET} ${COLOR_BOLD}$src${COLOR_RESET} -> ${COLOR_BOLD}$final_dest${COLOR_RESET} (${COLOR_BLUE}$size_fmt${COLOR_RESET})"
    fi
    
    if same_filesystem "$src" "$(dirname "$final_dest")"; then
        [ "$VERBOSE" = true ] && echo "  ${COLOR_CYAN}→${COLOR_RESET} Same filesystem, instant move"
        mv "$src" "$final_dest"
        PROCESSED_SIZE=$((PROCESSED_SIZE + item_size))
    else
        [ "$VERBOSE" = true ] && echo "  ${COLOR_CYAN}→${COLOR_RESET} Cross-filesystem, copying with progress..."
        
        if [ "$QUIET" = true ]; then
            rsync -a --remove-source-files "$src" "$final_dest" 2>/dev/null
        else
            if [ $TOTAL_SIZE -gt 0 ] && [ $PROCESSED_SIZE -gt 0 ]; then
                local elapsed=$(($(date +%s) - START_TIME))
                local speed=$((PROCESSED_SIZE / elapsed))
                if [ $speed -gt 0 ]; then
                    local remaining=$((TOTAL_SIZE - PROCESSED_SIZE))
                    local eta=$((remaining / speed))
                    local eta_fmt=$(format_time $eta)
                    echo "  ${COLOR_YELLOW}ETA:${COLOR_RESET} $eta_fmt (${COLOR_BLUE}$(format_size $speed)/s${COLOR_RESET})"
                fi
            fi
            
            rsync -ah --progress --remove-source-files "$src" "$final_dest"
        fi
        
        PROCESSED_SIZE=$((PROCESSED_SIZE + item_size))
        
        if [ -d "$src" ]; then
            find "$src" -type d -empty -delete 2>/dev/null
        fi
    fi
    
    return $?
}

TOTAL_FILES=${#SOURCES[@]}
SUCCESS_COUNT=0
FAIL_COUNT=0

if [ "$PREVIEW" = false ]; then
    START_TIME=$(date +%s)
    TOTAL_SIZE=$(calculate_total_size)
    
    if [ "$QUIET" = false ]; then
        echo "${COLOR_BLUE}Total size to move:${COLOR_RESET} ${COLOR_BOLD}$(format_size $TOTAL_SIZE)${COLOR_RESET}"
        echo ""
    fi
fi

if [ "$PREVIEW" = true ]; then
    TOTAL_SIZE=$(calculate_total_size)
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo "${COLOR_BOLD}PREVIEW MODE - No files will be moved${COLOR_RESET}"
    echo "${COLOR_BLUE}Total size:${COLOR_RESET} ${COLOR_BOLD}$(format_size $TOTAL_SIZE)${COLOR_RESET}"
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo ""
fi

for source in "${SOURCES[@]}"; do
    if move_item "$source" "$DEST"; then
        ((SUCCESS_COUNT++))
    else
        ((FAIL_COUNT++))
    fi
done

if [ "$QUIET" = false ] && [ "$PREVIEW" = false ]; then
    end_time=$(date +%s)
    total_time=$((end_time - START_TIME))
    time_fmt=$(format_time $total_time)
    
    echo ""
    echo "${COLOR_GREEN}=========================================${COLOR_RESET}"
    echo "${COLOR_BOLD}${COLOR_GREEN}Move completed in $time_fmt!${COLOR_RESET}"
    
    if [ $total_time -gt 0 ]; then
        avg_speed=$((TOTAL_SIZE / total_time))
        echo "${COLOR_BLUE}Average speed:${COLOR_RESET} ${COLOR_BOLD}$(format_size $avg_speed)/s${COLOR_RESET}"
    fi
    
    echo "${COLOR_BLUE}Total:${COLOR_RESET} $TOTAL_FILES | ${COLOR_GREEN}Success:${COLOR_RESET} $SUCCESS_COUNT | ${COLOR_RED}Failed:${COLOR_RESET} $FAIL_COUNT"
    echo "${COLOR_GREEN}=========================================${COLOR_RESET}"
elif [ "$PREVIEW" = true ]; then
    echo ""
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
    echo "${COLOR_BOLD}Preview completed - $TOTAL_FILES items would be moved${COLOR_RESET}"
    echo "${COLOR_BLUE}Estimated size:${COLOR_RESET} ${COLOR_BOLD}$(format_size $TOTAL_SIZE)${COLOR_RESET}"
    echo "${COLOR_CYAN}=========================================${COLOR_RESET}"
fi

exit $([ $FAIL_COUNT -eq 0 ] && echo 0 || echo 1)
